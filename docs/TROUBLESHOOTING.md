# Troubleshooting Guide

This comprehensive guide helps you diagnose and resolve common issues with the Neo4j MCP server across different platforms and environments.

## ðŸš¨ Quick Diagnostic Commands

Before diving into specific issues, run these commands to gather information:

```bash
# Check package installation
python -c "import neo4j_mcp; print('Package: OK')"

# Check server functionality
python -m neo4j_mcp.server --help

# Test with mock data (no Neo4j required)
NEO4J_MOCK=true python -m neo4j_mcp.server

# Check Neo4j connectivity (if Neo4j is running)
python -c "from neo4j import GraphDatabase; driver = GraphDatabase.driver('neo4j://localhost:7687', auth=('neo4j', 'password')); print('Neo4j: OK'); driver.close()"
```

---

## ðŸ” Installation Issues

### Problem: Package Import Fails
```bash
ImportError: No module named 'neo4j_mcp'
```

**Diagnosis**:
```bash
# Check if package is installed
pip list | grep neo4j

# Check Python path
python -c "import sys; print(sys.path)"
```

**Solutions**:
1. **Install the package**:
   ```bash
   cd /path/to/neo4j_mcp
   pip install -e .
   ```

2. **Check virtual environment**:
   ```bash
   # Activate your virtual environment first
   source venv/bin/activate  # Linux/Mac
   # or
   venv\Scripts\activate     # Windows
   pip install -e .
   ```

3. **Python version mismatch**:
   ```bash
   # Check Python version
   python --version  # Should be 3.8+

   # Use specific Python version
   python3.10 -m pip install -e .
   ```

### Problem: Dependency Installation Fails
```bash
ERROR: Could not install packages due to an EnvironmentError
```

**Solutions**:
1. **Update pip**:
   ```bash\n   python -m pip install --upgrade pip\n   ```\n\n2. **Install build tools** (Linux/Mac):\n   ```bash\n   # Ubuntu/Debian\n   sudo apt-get install build-essential python3-dev\n   \n   # macOS\n   xcode-select --install\n   ```\n\n3. **Windows build tools**:\n   - Install Visual Studio Build Tools\n   - Or use conda: `conda install neo4j python-dotenv pydantic`\n\n4. **Permission issues**:\n   ```bash\n   # Install for current user only\n   pip install --user -e .\n   \n   # Or use sudo (Linux/Mac)\n   sudo pip install -e .\n   ```\n\n---\n\n## ðŸŒ Connection Issues\n\n### Problem: \"Failed to connect to Neo4j\"\n```\nServiceUnavailable: Failed to connect to Neo4j after trying X URI(s)\n```\n\n**Diagnosis**:\n```bash\n# Test direct Neo4j connection\ntelnet localhost 7687\n\n# Check if Neo4j is running\n# Windows: Check Neo4j Desktop or Services\n# Linux: systemctl status neo4j\n# macOS: brew services list | grep neo4j\n# Docker: docker ps | grep neo4j\n```\n\n**Solutions by Platform**:\n\n#### Windows\n1. **Neo4j Desktop**:\n   - Open Neo4j Desktop\n   - Ensure database is started (green play button)\n   - Check connection settings in database details\n\n2. **Neo4j Server**:\n   ```cmd\n   # Check Windows service\n   sc query neo4j\n   \n   # Start service if stopped\n   sc start neo4j\n   ```\n\n3. **Firewall settings**:\n   ```cmd\n   # Allow Neo4j through Windows Firewall\n   netsh advfirewall firewall add rule name=\"Neo4j\" dir=in action=allow protocol=TCP localport=7687\n   ```\n\n#### macOS\n1. **Homebrew Neo4j**:\n   ```bash\n   # Check service status\n   brew services list | grep neo4j\n   \n   # Start Neo4j\n   brew services start neo4j\n   \n   # Restart if already running\n   brew services restart neo4j\n   ```\n\n2. **Manual start**:\n   ```bash\n   # Find Neo4j installation\n   /usr/local/Cellar/neo4j/*/bin/neo4j start\n   ```\n\n#### Linux\n1. **SystemD service**:\n   ```bash\n   # Check service status\n   sudo systemctl status neo4j\n   \n   # Start service\n   sudo systemctl start neo4j\n   \n   # Enable auto-start\n   sudo systemctl enable neo4j\n   ```\n\n2. **Docker**:\n   ```bash\n   # Check running containers\n   docker ps\n   \n   # Start Neo4j container\n   docker run -d \\\n     --name neo4j \\\n     -p 7687:7687 -p 7474:7474 \\\n     -e NEO4J_AUTH=neo4j/password \\\n     neo4j:latest\n   ```\n\n#### WSL (Special Case)\n1. **Configure Neo4j on Windows to accept external connections**:\n   ```\n   # Edit neo4j.conf (Windows side)\n   dbms.default_listen_address=0.0.0.0\n   dbms.connector.bolt.listen_address=0.0.0.0:7687\n   ```\n\n2. **Windows Firewall**:\n   ```cmd\n   # Allow WSL access\n   netsh advfirewall firewall add rule name=\"Neo4j WSL\" dir=in action=allow protocol=TCP localport=7687\n   ```\n\n3. **Test WSL connectivity**:\n   ```bash\n   # Check Windows host IP detection\n   python3 -c \"from neo4j_mcp.config import Neo4jConfig; print('Host IP:', Neo4jConfig().get_windows_host_ip())\"\n   \n   # Test connection to detected IP\n   telnet $(python3 -c \"from neo4j_mcp.config import Neo4jConfig; print(Neo4jConfig().get_windows_host_ip())\") 7687\n   ```\n\n### Problem: Authentication Failures\n```\nAuthError: The client is unauthorized due to authentication failure\n```\n\n**Diagnosis**:\n```bash\n# Test credentials with cypher-shell\ncypher-shell -a neo4j://localhost:7687 -u neo4j -p your-password \"RETURN 1\"\n\n# Test with Neo4j Browser\n# Open http://localhost:7474 in browser\n```\n\n**Solutions**:\n1. **Default credentials**:\n   - Default username: `neo4j`\n   - Default password: `neo4j` (must be changed on first login)\n\n2. **Reset password**:\n   ```bash\n   # Stop Neo4j\n   # Delete data/dbms/auth file\n   # Restart Neo4j (will prompt for new password)\n   ```\n\n3. **Check user permissions**:\n   ```cypher\n   # In Neo4j Browser or cypher-shell\n   SHOW USERS;\n   SHOW ROLES FOR USER username;\n   ```\n\n---\n\n## âš™ï¸ MCP Server Issues\n\n### Problem: \"Server Not Starting\" in Claude Code\n```\nFailed to start MCP server: neo4j\n```\n\n**Diagnosis**:\n```bash\n# Check if server runs manually\npython -m neo4j_mcp.server --help\n\n# Check Python path in Claude Code configuration\nwhich python\n# or\nwhereis python3\n```\n\n**Solutions**:\n1. **Fix Python path**:\n   ```json\n   {\n     \"mcpServers\": {\n       \"neo4j\": {\n         \"command\": \"/full/path/to/python\",\n         \"args\": [\"-m\", \"neo4j_mcp.server\"]\n       }\n     }\n   }\n   ```\n\n2. **Check working directory**:\n   ```json\n   {\n     \"mcpServers\": {\n       \"neo4j\": {\n         \"cwd\": \"/absolute/path/to/neo4j_mcp\"\n       }\n     }\n   }\n   ```\n\n3. **Verify package installation in the correct environment**:\n   ```bash\n   # Test with the exact command from Claude Code config\n   /full/path/to/python -c \"import neo4j_mcp; print('OK')\"\n   ```\n\n### Problem: \"Tools Not Appearing\" in Claude Code\n\n**Diagnosis**:\n```bash\n# Check Claude Code MCP logs\n# Location varies by platform:\n# ~/.cache/claude-cli-nodejs/*/mcp-logs-neo4j/\n\ntail -f ~/.cache/claude-cli-nodejs/*/mcp-logs-neo4j/*.txt\n```\n\n**Common Log Messages and Solutions**:\n\n1. **\"Connection refused\"**:\n   - Neo4j is not running\n   - Wrong host/port configuration\n   - Firewall blocking connection\n\n2. **\"Authentication failed\"**:\n   - Wrong username/password\n   - User doesn't exist\n   - Insufficient permissions\n\n3. **\"Tool registration failed\"**:\n   - Check environment variables\n   - Verify tool is enabled (`NEO4J_ENABLE_*=true`)\n\n4. **\"Import error\"**:\n   - Package not installed correctly\n   - Python path issues\n   - Missing dependencies\n\n### Problem: \"Runtime Configuration Not Working\"\n\n**Symptoms**: `neo4j_configure` tool not responding\n\n**Solutions**:\n1. **Check tool is always available**:\n   ```bash\n   # This tool should always work, even without Neo4j\n   python -c \"from neo4j_mcp.tools.config_tool import neo4j_configure; print('Config tool OK')\"\n   ```\n\n2. **Test in mock mode**:\n   ```bash\n   NEO4J_MOCK=true python -m neo4j_mcp.server\n   ```\n\n3. **Check server instance**:\n   - Configuration tool requires server instance reference\n   - Verify server initialization completed\n\n---\n\n## ðŸ—„ï¸ Database Issues\n\n### Problem: \"Schema Tool Returns Empty Results\"\n\n**Diagnosis**:\n```cypher\n# Test basic schema queries manually\nCALL db.labels();\nCALL db.relationshipTypes();\nCALL db.schema.visualization();\n```\n\n**Solutions**:\n1. **Database has no data**:\n   ```cypher\n   # Check if database has any nodes\n   MATCH (n) RETURN count(n);\n   \n   # Create sample data for testing\n   CREATE (p:Person {name: \"Test User\", age: 30});\n   ```\n\n2. **Using wrong database**:\n   ```bash\n   # Check current database\n   export NEO4J_DATABASE=\"your-database-name\"\n   ```\n\n3. **Permissions issue**:\n   ```cypher\n   # Check user can access schema procedures\n   CALL db.labels() YIELD label RETURN label LIMIT 1;\n   ```\n\n### Problem: \"Write Operations Fail\"\n\n**Symptoms**: \"Transaction failed\" or \"Permission denied\"\n\n**Solutions**:\n1. **Check write permissions**:\n   ```cypher\n   # Test simple write operation\n   CREATE (test:TestNode {created: datetime()}) RETURN test;\n   DELETE test;\n   ```\n\n2. **Database read-only mode**:\n   ```\n   # Check neo4j.conf\n   dbms.databases.default_to_read_only=false\n   ```\n\n3. **User permissions**:\n   ```cypher\n   # Check user roles\n   SHOW ROLES FOR USER your-username;\n   \n   # Grant write permissions\n   GRANT ROLE editor TO your-username;\n   ```\n\n### Problem: \"Query Timeout\"\n\n**Symptoms**: \"Query execution timeout\" or \"Connection lost\"\n\n**Solutions**:\n1. **Increase timeout**:\n   ```bash\n   export NEO4J_CONNECTION_TIMEOUT=60  # seconds\n   ```\n\n2. **Optimize queries**:\n   ```cypher\n   # Add LIMIT to large queries\n   MATCH (n) RETURN n LIMIT 100;\n   \n   # Use indexes for better performance\n   CREATE INDEX FOR (p:Person) ON p.name;\n   ```\n\n3. **Check Neo4j performance**:\n   ```cypher\n   # Check running queries\n   CALL dbms.listQueries();\n   \n   # Kill long-running queries\n   CALL dbms.killQuery('query-id');\n   ```\n\n---\n\n## ðŸ”§ Platform-Specific Issues\n\n### Windows-Specific Problems\n\n#### Problem: \"Python not found\"\n```\n'python' is not recognized as an internal or external command\n```\n\n**Solutions**:\n1. **Use full path**:\n   ```json\n   \"command\": \"C:\\\\Python39\\\\python.exe\"\n   ```\n\n2. **Add Python to PATH**:\n   - Control Panel â†’ System â†’ Advanced â†’ Environment Variables\n   - Add Python installation directory to PATH\n\n3. **Use py launcher**:\n   ```json\n   \"command\": \"py\",\n   \"args\": [\"-3\", \"-m\", \"neo4j_mcp.server\"]\n   ```\n\n#### Problem: \"Access denied\" errors\n\n**Solutions**:\n1. **Run as administrator** (for installation only)\n2. **Install for current user**: `pip install --user -e .`\n3. **Check antivirus**: Exclude Python and Neo4j directories\n\n### macOS-Specific Problems\n\n#### Problem: \"Permission denied\" or \"Operation not permitted\"\n\n**Solutions**:\n1. **Use Homebrew Python**:\n   ```bash\n   brew install python\n   /usr/local/bin/python3 -m pip install -e .\n   ```\n\n2. **macOS Gatekeeper**:\n   ```bash\n   # Allow Neo4j if blocked\n   sudo xattr -rd com.apple.quarantine /path/to/neo4j\n   ```\n\n3. **SSL Certificate issues**:\n   ```bash\n   pip install --upgrade certifi\n   /Applications/Python\\ 3.x/Install\\ Certificates.command\n   ```\n\n### Linux-Specific Problems\n\n#### Problem: \"Package installation fails\"\n\n**Solutions**:\n1. **Install build dependencies**:\n   ```bash\n   # Ubuntu/Debian\n   sudo apt-get update\n   sudo apt-get install build-essential python3-dev python3-pip\n   \n   # CentOS/RHEL\n   sudo yum install gcc python3-devel python3-pip\n   \n   # Fedora\n   sudo dnf install gcc python3-devel python3-pip\n   ```\n\n2. **Python version issues**:\n   ```bash\n   # Install specific Python version\n   sudo apt-get install python3.10 python3.10-pip python3.10-dev\n   python3.10 -m pip install -e .\n   ```\n\n#### Problem: \"Neo4j service issues\"\n\n**Solutions**:\n1. **Check service logs**:\n   ```bash\n   sudo journalctl -u neo4j -f\n   ```\n\n2. **Fix file permissions**:\n   ```bash\n   sudo chown -R neo4j:neo4j /var/lib/neo4j\n   sudo chmod -R 755 /var/lib/neo4j\n   ```\n\n3. **Memory issues**:\n   ```bash\n   # Edit /etc/neo4j/neo4j.conf\n   dbms.memory.heap.initial_size=512m\n   dbms.memory.heap.max_size=1G\n   ```\n\n### WSL-Specific Problems\n\n#### Problem: \"Windows host IP changes\"\n\n**Symptoms**: Connection works initially but fails later\n\n**Solutions**:\n1. **The server handles this automatically**, but you can check:\n   ```bash\n   # Check current Windows host IP\n   python3 -c \"from neo4j_mcp.config import Neo4jConfig; print(Neo4jConfig().get_windows_host_ip())\"\n   ```\n\n2. **Static IP configuration** (if dynamic detection fails):\n   ```bash\n   export NEO4J_WINDOWS_HOST_IP=\"192.168.1.100\"\n   ```\n\n#### Problem: \"File system path issues\"\n\n**Solutions**:\n1. **Use Windows paths for shared files**:\n   ```json\n   \"cwd\": \"/mnt/c/Users/YourName/neo4j_mcp\"\n   ```\n\n2. **Fix permissions on mounted drives**:\n   ```bash\n   # Edit /etc/wsl.conf\n   [automount]\n   options = \"metadata,uid=1000,gid=1000,umask=22\"\n   ```\n\n---\n\n## ðŸ¥ Emergency Recovery\n\n### Complete Reset Procedure\n\nIf everything fails, follow this step-by-step reset:\n\n1. **Clean Python environment**:\n   ```bash\n   pip uninstall neo4j_mcp neo4j mcp rich python-dotenv pydantic\n   ```\n\n2. **Fresh installation**:\n   ```bash\n   cd /path/to/neo4j_mcp\n   pip install -r requirements.txt\n   pip install -e .\n   ```\n\n3. **Test in isolation**:\n   ```bash\n   # Test with mock (no external dependencies)\n   NEO4J_MOCK=true python -m neo4j_mcp.server\n   ```\n\n4. **Verify Neo4j separately**:\n   ```bash\n   # Test Neo4j with browser\n   # Open http://localhost:7474\n   \n   # Test with cypher-shell\n   cypher-shell -u neo4j -p password \"RETURN 1\"\n   ```\n\n5. **Test connection integration**:\n   ```bash\n   python test_connectivity.py\n   ```\n\n6. **Reconfigure Claude Code**:\n   - Use absolute paths\n   - Start with minimal configuration\n   - Add environment variables incrementally\n\n### Log Analysis\n\n**Enable debug logging**:\n```python\n# Add to your Python environment\nimport logging\nlogging.basicConfig(level=logging.DEBUG)\n```\n\n**Key log locations**:\n- **MCP Server logs**: `~/.cache/claude-cli-nodejs/*/mcp-logs-neo4j/`\n- **Neo4j logs**: \n  - Windows: `%NEO4J_HOME%/logs/`\n  - Linux: `/var/log/neo4j/`\n  - macOS: `/usr/local/var/log/neo4j/`\n  - Docker: `docker logs neo4j-container`\n\n**Common log patterns**:\n```bash\n# Connection issues\ngrep -i \"connection\" /path/to/logfile\n\n# Authentication problems\ngrep -i \"auth\" /path/to/logfile\n\n# Import/package issues\ngrep -i \"import\\|module\" /path/to/logfile\n```\n\n---\n\n## ðŸ†˜ Getting Help\n\nIf this troubleshooting guide doesn't solve your issue:\n\n1. **Gather diagnostic information**:\n   ```bash\n   # Create diagnostic report\n   echo \"=== System Info ===\" > diagnostic.txt\n   python --version >> diagnostic.txt\n   pip --version >> diagnostic.txt\n   echo \"\\n=== Package Info ===\" >> diagnostic.txt\n   pip list | grep -E \"neo4j|mcp|rich|pydantic\" >> diagnostic.txt\n   echo \"\\n=== Neo4j Status ===\" >> diagnostic.txt\n   # Add your Neo4j status check here\n   echo \"\\n=== Environment ===\" >> diagnostic.txt\n   env | grep NEO4J >> diagnostic.txt\n   ```\n\n2. **Check existing issues**: \n   - [GitHub Issues](https://github.com/your-username/neo4j_mcp/issues)\n   - [GitHub Discussions](https://github.com/your-username/neo4j_mcp/discussions)\n\n3. **Create a new issue** with:\n   - Your platform (Windows/macOS/Linux/WSL)\n   - Complete error messages\n   - Steps to reproduce\n   - Diagnostic report from step 1\n   - Claude Code configuration (remove sensitive data)\n\n4. **Community support**:\n   - Neo4j Community Forum\n   - Model Context Protocol discussions\n   - Claude Code user community\n\n---\n\n## âœ… Prevention Tips\n\n1. **Regular maintenance**:\n   ```bash\n   # Keep packages updated\n   pip install --upgrade neo4j_mcp\n   \n   # Clean up old logs\n   find ~/.cache/claude-cli-nodejs -name \"*.txt\" -mtime +30 -delete\n   ```\n\n2. **Environment management**:\n   - Use virtual environments for Python projects\n   - Keep Neo4j updated to latest stable version\n   - Backup Neo4j configuration before changes\n\n3. **Monitoring**:\n   - Monitor Neo4j performance and logs\n   - Set up alerts for connection failures\n   - Regular testing with mock mode\n\n4. **Documentation**:\n   - Document your specific configuration\n   - Keep notes on platform-specific tweaks\n   - Share working configurations with team\n\nRemember: Most issues are related to connection, authentication, or path configuration. Start with the basics and work your way up to more complex scenarios."